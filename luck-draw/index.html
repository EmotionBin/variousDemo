<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>luck-draw</title>
  <script src="./vendor/vue/vue.js"></script>
  <style>
    *{
      margin: 0;
    }
    .head{
      text-align: center;
    }
    .luck-draw{
      height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .luck-draw-wrap{
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .row{
      display: flex;
      justify-content: space-around;
    }
    .row-square{
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100px;
      height: 100px;
      margin: 5px;
      background-color: #c1c1c1;
      box-shadow: 0 0 5px #d1d1d1;
      border-radius: 5px;
    }
    .row-square.active{
      background-color: #a20;;
    }
    .start{
      background-color: #e67e22;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="head">
    <h1>ä¹å®«æ ¼æŠ½å¥–ğŸ˜</h1>
  </div>
  <div class="luck-draw">
    <div class="luck-draw-wrap">
      <div class="row">
        <div class="row-square" :class="{'active':1 === currentNum}">1</div>
        <div class="row-square" :class="{'active':2 === currentNum}">2</div>
        <div class="row-square" :class="{'active':3 === currentNum}">3</div>
      </div>
      <div class="row">
        <div class="row-square" :class="{'active':4 === currentNum}">4</div>
        <div class="row-square start" @click="start">å¼€å§‹æŠ½å¥–</div>
        <div class="row-square" :class="{'active':6 === currentNum}">6</div>
      </div>
      <div class="row">
        <div class="row-square" :class="{'active':7 === currentNum}">7</div>
        <div class="row-square" :class="{'active':8 === currentNum}">8</div>
        <div class="row-square" :class="{'active':9 === currentNum}">9</div>
      </div>
    </div>
  </div>
</body>
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.js"></script>
<script type="text/javascript">
  class LuckDraw {
    constructor(DataArr, RotateDir, cycleNumber, minSpeed) {
      this.DataArr = JSON.parse(JSON.stringify(DataArr));

      // æœ€å¤§é€Ÿåº¦
      this.maxSpeed = 4;
      // åœˆæ•° ä¸ä¼ é»˜è®¤ä¸º2
      this.cycleNumber = cycleNumber || 2;
      this.myReq;
      // æœ€å°é€Ÿåº¦
      this.defaultSpeed = minSpeed || 15;

      for (var i = 0; i < RotateDir.length; i++) {
        let { index, next } = RotateDir[i];
        if (typeof this.DataArr[index].next !== "undefined") {
          console.error(`RotateDir is error`);
          return;
        }
        this.DataArr[index].next = this.DataArr[next];
      }
    }

    run(id, running, runend) {
      var counter = 0; // è®¡æ•°å™¨
      var current = 0; // å½“å‰æ•°å­—å€¼
      var n = 0;
      var currentObj = this.DataArr[0];
      var tem = this.DataArr[0];
      while (true) {
        if (n > this.DataArr.length) {
          console.error(`${id}ä¸å­˜åœ¨`);
          return;
        }
        if (tem.id == id) {
          break;
        }
        tem = tem.next;
        n++;
      }
      var allCount = this.cycleNumber * this.DataArr.length + n;
      // åŠ é€ŸåŒºé—´
      var addSpeed = this.defaultSpeed - this.maxSpeed;
      // å‡é€ŸåŒºé—´
      var reduceSpeed = allCount - (this.defaultSpeed - this.maxSpeed);
      this.running = running;
      this.runend = runend;
      var _this = this;
      this.running(currentObj);
      this.myReq = requestAnimationFrame(step);
      function step() {
        // current++;
        // åŠ é€Ÿç¯èŠ‚
        if (counter < addSpeed) {
          if (current < Math.pow(_this.defaultSpeed - counter, 2)) {
            current = current + _this.defaultSpeed / 2;
          } else {
            current = 0;
            // å¾€å‰ç§»åŠ¨ä¸€ä¸ªï¼›
            counter++;
            currentObj = currentObj.next;
            _this.running(currentObj);
          }
        }
        // åŒ€é€Ÿç¯èŠ‚
        if (counter >= addSpeed && counter < reduceSpeed) {
          if (current < _this.maxSpeed) {
            current++;
          } else {
            // è®¡æ•°æ¸…é›¶
            current = 0;
            // å¾€å‰ç§»åŠ¨ä¸€ä¸ªï¼›
            counter++;
            currentObj = currentObj.next;
            _this.running(currentObj);
          }
        }
        // å‡é€Ÿç¯èŠ‚
        if (counter >= reduceSpeed && counter < allCount) {
          if (Math.sqrt(current) <= (_this.defaultSpeed - (allCount - counter))) {
            current = current + 2;
          } else {
            // è®¡æ•°æ¸…é›¶
            current = 0;
            // å¾€å‰ç§»åŠ¨ä¸€ä¸ªï¼›
            counter++;
            currentObj = currentObj.next;
            _this.running(currentObj);
          }
        }
        // åœæ­¢
        if (counter >= allCount) {
          cancelAnimationFrame(_this.myReq);
          _this.runend(currentObj);
          return;
        }
        _this.myReq = requestAnimationFrame(step);
      }
    }
  }

  // æœåŠ¡ç«¯è¿”å›çš„å¥–å“ä¿¡æ¯åˆ—è¡¨
  const prizeList = [
    { id: 1 , value:'ä¸€å—é’±'},
    { id: 2 , value:'ä¸¤å—é’±'},
    { id: 3 , value:'ä¸‰å—é’±'},
    { id: 6 , value:'å…­å—é’±'},
    { id: 9 , value:'ä¹å—é’±'},
    { id: 8 , value:'å…«å—é’±'},
    { id: 7 , value:'ä¸ƒå—é’±'},
    { id: 4 , value:'å››å—é’±'},
  ];

  // æ—‹è½¬è§„åˆ™æ•°ç»„ 
  const rotateDir = [
    { index: 0, next: 1 },
    { index: 1, next: 2 },
    { index: 2, next: 3 },
    { index: 3, next: 4 },
    { index: 4, next: 5 },
    { index: 5, next: 6 },
    { index: 6, next: 7 },
    { index: 7, next: 0 },
  ]

  const luckDraw_el = new Vue({
    el:'.luck-draw',
    data:{
      currentNum:-1,
      target:-1
    },
    mounted(){
    },
    computed:{
      
    },
    methods:{
      // ç›¸åŒæ¦‚ç‡ç”Ÿæˆ1-8ä¹‹é—´çš„éšæœºæ•°ï¼Œä¹Ÿå°±æ˜¯ä¸­å¥–çš„æ•°å­—
      getTarget(){
        const num = Math.floor(Math.random() * 8 + 1);
        return num === 5 ? this.getTarget() : num;
      },
      // å¼€å§‹æŠ½å¥–
      start(){
        this.target = this.getTarget();
        console.log('this.target: ', this.target);
        if(!this.luckDrawFn){
          // åˆå§‹åŒ–æŠ½å¥–, 3ä»£è¡¨åœˆæ•°ï¼Œ 8ä»£è¡¨é€Ÿåº¦ï¼Œä¹Ÿä»£è¡¨æ—¶é—´ç‰‡çš„ä¸ªæ•°
          this.luckDrawFn = new LuckDraw(prizeList, rotateDir, 3, 8);
        }
        this.luckDrawFn.run(
          this.target, //ä¸­å¥–å·ç 
          params => { // åœç•™åœ¨å½“å‰æ ¼å­çš„å›è°ƒå‡½æ•°
            // æ‹¿åˆ°å½“å‰ active çŠ¶æ€çš„ id
            this.currentNum = params.id;
          },
          params => { // æœ€ç»ˆåœæ­¢çš„å›è°ƒå‡½æ•°
            //æœ€åè½¬ç›˜åœæ­¢çš„åœ°æ–¹ï¼Œå¯ä»¥å¼¹å‡ºå¥–åŠ±å¼¹æ¡†æˆ–å…¶ä»–æ“ä½œ
            this.currentNum = params.id;
            // è¿™é‡Œå¿…é¡»è¦ç”¨settimeout
            setTimeout(() => {
              alert(`æ­å–œæ‚¨ä¸­å¥–å•¦ï¼å¥–å“æ˜¯${params.value}`);
            }, 0);
          }
        )
      }
    }
  });
</script>
</html>